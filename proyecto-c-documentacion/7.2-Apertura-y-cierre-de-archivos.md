# 7.2. Apertura y Cierre de Archivos

Para poder leer o escribir en un archivo, un programa primero debe "abrirlo". Este proceso establece una conexión (un flujo o _stream_) entre el programa y el archivo en el sistema de archivos. Una vez que se han completado todas las operaciones, el archivo debe ser "cerrado" para asegurar que todos los datos se escriban correctamente y se liberen los recursos del sistema.

## Apertura de un Archivo: `fopen()`

La función `fopen()` de la biblioteca `<stdio.h>` se utiliza para abrir un archivo.

**Sintaxis:**
`FILE *fopen(const char *nombre_archivo, const char *modo);`

- `nombre_archivo`: Una cadena que contiene la ruta y el nombre del archivo que se desea abrir.
- `modo`: Una cadena que especifica cómo se abrirá el archivo (para lectura, escritura, etc.).
- **Valor de Retorno:**
  - Si la apertura es exitosa, `fopen()` devuelve un apuntador `FILE *` que identifica el flujo.
  - Si ocurre un error (el archivo no existe, no hay permisos, etc.), `fopen()` devuelve `NULL`.

**Es absolutamente crucial comprobar siempre si `fopen()` devolvió `NULL` para manejar los errores de apertura de archivos de forma robusta.**

### Modos de Apertura Principales

| Modo      | Descripción                                                               | ¿Qué pasa si el archivo no existe? | ¿Qué pasa si el archivo ya existe?                                                            |
| :-------- | :------------------------------------------------------------------------ | :--------------------------------- | :-------------------------------------------------------------------------------------------- |
| **`"r"`** | **Read (Leer)**: Abre un archivo de texto para lectura.                   | `fopen` falla (devuelve `NULL`).   | El cursor de lectura se posiciona al principio.                                               |
| **`"w"`** | **Write (Escribir)**: Abre un archivo de texto para escritura.            | Se crea un nuevo archivo.          | **Se borra todo el contenido existente.** El cursor se posiciona al principio.                |
| **`"a"`** | **Append (Añadir)**: Abre un archivo de texto para añadir datos al final. | Se crea un nuevo archivo.          | El cursor de escritura se posiciona al final del archivo. El contenido existente se conserva. |

### Modos Extendidos

Existen modos adicionales que combinan lectura y escritura, y especifican el tipo de archivo (texto o binario):

- **`"r+"`**: Abre para **lectura y escritura**. El archivo debe existir.
- **`"w+"`**: Abre para **lectura y escritura**. Crea el archivo si no existe, o borra su contenido si existe.
- **`"a+"`**: Abre para **lectura y añadir**. Crea el archivo si no existe. La lectura comienza desde el principio, pero la escritura siempre es al final.
- **Modo Binario**: Se puede añadir una `b` a cualquiera de los modos anteriores (ej. `"rb"`, `"wb"`, `"ab+"`) para indicar que el archivo debe tratarse como binario, evitando las traducciones de caracteres de fin de línea.

**Ejemplo de apertura segura:**

```c
#include <stdio.h>

int main() {
    FILE *archivo_lectura;

    archivo_lectura = fopen("mi_archivo.txt", "r");

    if (archivo_lectura == NULL) {
        perror("Error al intentar abrir mi_archivo.txt");
        // perror imprime un mensaje de error descriptivo del sistema.
        return 1; // Termina el programa con un código de error.
    }

    // ... operaciones de lectura ...

    // No olvides cerrar el archivo.
    fclose(archivo_lectura);

    return 0;
}
```

## Cierre de un Archivo: `fclose()`

La función `fclose()` se utiliza para cerrar un flujo que fue abierto previamente.

**Sintaxis:**
`int fclose(FILE *flujo);`

- `flujo`: El apuntador `FILE *` que se obtuvo de `fopen()`.

**¿Por qué es tan importante cerrar un archivo?**

1.  **Vaciar el Búfer (Flushing)**: Las operaciones de escritura en C a menudo se almacenan en un búfer en memoria para mejorar el rendimiento. `fclose()` se asegura de que todos los datos pendientes en el búfer se escriban físicamente en el archivo. Si un programa termina sin cerrar un archivo, los últimos datos escritos podrían perderse.
2.  **Liberar Recursos del Sistema**: El sistema operativo tiene un límite en el número de archivos que un programa puede tener abiertos simultáneamente. `fclose()` libera los recursos asociados con el flujo, permitiendo que otros archivos sean abiertos. No cerrar archivos en un programa de larga duración puede llevar a una fuga de recursos.

**Ejemplo completo:**

```c
#include <stdio.h>

int main() {
    FILE *archivo_salida = fopen("log.txt", "a"); // Abrir para añadir

    if (archivo_salida == NULL) {
        perror("No se pudo abrir log.txt");
        return 1;
    }

    fprintf(archivo_salida, "El programa se inició correctamente.\n");

    // ... el programa hace su trabajo ...

    fprintf(archivo_salida, "El programa está a punto de terminar.\n");

    // Cerrar el archivo para asegurar que todo se escriba y se liberen los recursos.
    fclose(archivo_salida);

    return 0;
}
```

## Comparación con JavaScript (Node.js)

En Node.js, el manejo de archivos también implica abrirlos y cerrarlos, pero a menudo se hace de forma diferente.

- **Funciones de Alto Nivel**: Funciones como `fs.writeFileSync()` o `fs.appendFileSync()` manejan el ciclo completo de abrir, escribir y cerrar el archivo en una sola llamada. Esto es más simple para operaciones atómicas.
  ```javascript
  const fs = require("fs");
  fs.appendFileSync("log.txt", "Entrada de log desde Node.js\n");
  ```
- **Manejo de Descriptores de Archivo**: Para un control más fino, se puede usar `fs.openSync()` para obtener un "descriptor de archivo" (un número, no un objeto complejo como `FILE *`). Luego se usan funciones como `fs.writeSync()` y finalmente se debe llamar a `fs.closeSync()` con ese descriptor. Este modelo es conceptualmente más cercano al de C.

## Resumen

- `fopen()` abre un archivo en un **modo** específico (`"r"`, `"w"`, `"a"`, etc.) y devuelve un apuntador `FILE *`.
- Es **imperativo** comprobar si `fopen()` devuelve `NULL` para manejar errores.
- `fclose()` cierra el archivo, lo que es crucial para **vaciar el búfer de escritura** y **liberar recursos** del sistema.
- El ciclo `fopen()` -> operaciones -> `fclose()` es la base para todo el manejo de archivos en C.

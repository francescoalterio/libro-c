# 8.4. Compilación Condicional

La compilación condicional es una de las características más poderosas del preprocesador de C. Permite incluir o excluir bloques de código del archivo fuente antes de que comience la compilación real. Esto es increíblemente útil para:

- **Portabilidad**: Escribir código que se compila de manera diferente según el sistema operativo o la arquitectura.
- **Depuración**: Incluir código de depuración (como `printf`s adicionales) que se puede "apagar" fácilmente en la versión final del programa.
- **Configuración**: Crear múltiples versiones de un programa desde la misma base de código.

## Directivas de Compilación Condicional

### `#ifdef` y `#ifndef`

Estas directivas comprueban si una macro ha sido definida.

- `#ifdef NOMBRE_MACRO`: "Si `NOMBRE_MACRO` está definido...". El bloque de código siguiente se incluye si `NOMBRE_MACRO` ha sido previamente definido con `#define`.
- `#ifndef NOMBRE_MACRO`: "Si `NOMBRE_MACRO` no está definido...". Es la negación de `#ifdef`.

Todo bloque condicional debe terminar con `#endif`.

**Ejemplo: Código de Depuración**

```c
#include <stdio.h>

// Para activar el modo depuración, simplemente define la macro DEBUG.
// Puedes hacerlo aquí o pasándolo como argumento al compilador (ej. gcc -DDEBUG ...).
#define DEBUG

int main() {
    int x = 10;
    printf("Este mensaje siempre se muestra.\n");

    #ifdef DEBUG
        // Este bloque solo se compila si DEBUG está definido.
        printf("[DEBUG] El valor de x es: %d\n", x);
        printf("[DEBUG] Dirección de x: %p\n", (void*)&x);
    #endif

    printf("Fin del programa.\n");
    return 0;
}
```

Si comentas la línea `#define DEBUG`, los `printf` de depuración desaparecerán del programa compilado, haciéndolo más pequeño y rápido.

### `#if`, `#else` y `#elif`

Mientras que `#ifdef` solo comprueba la existencia de una macro, `#if` permite evaluar expresiones constantes enteras.

- `#if expresion_constante`: Incluye el código si la `expresion_constante` se evalúa como un valor distinto de cero. La expresión solo puede contener constantes enteras, caracteres y macros previamente definidas.
- `#else`: Proporciona un bloque de código alternativo si la condición `#if`, `#ifdef` o `#ifndef` es falsa.
- `#elif expresion_constante`: "else if". Permite encadenar múltiples condiciones.

**Ejemplo: Configuración de Versiones**

```c
#define VERSION 3

#if VERSION == 1
    char* nombre_version = "Básica";
#elif VERSION == 2
    char* nombre_version = "Profesional";
#elif VERSION > 2
    char* nombre_version = "Empresarial";
#else
    char* nombre_version = "No definida";
#endif

printf("Bienvenido a la versión %s.\n", nombre_version);
```

### El Operador `defined()`

El operador `defined()` se puede usar dentro de una expresión `#if` o `#elif` y devuelve `1` si la macro que se le pasa como argumento está definida, y `0` si no lo está. Es más flexible que `#ifdef` porque permite combinar varias comprobaciones con operadores lógicos (`&&`, `||`).

**Ejemplo: Portabilidad Avanzada**

```c
#if defined(_WIN32) && defined(PROCESADOR_64_BITS)
    // Código específico para Windows de 64 bits
#elif defined(__linux__)
    // Código específico para cualquier distribución de Linux
#else
    // Código genérico para otros sistemas
#endif
```

## Comparación con JavaScript

Como se mencionó anteriormente, JavaScript no tiene una fase de preprocesamiento. El código condicional se resuelve en tiempo de ejecución. Sin embargo, el ecosistema de herramientas de JavaScript ha desarrollado técnicas para lograr un resultado similar.

| Escenario en C                   | Técnica Equivalente en JavaScript (Node.js / Bundlers)                                                                                                                                                                                                                                                                                      |
| :------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Código de Depuración**         | **Variables de Entorno**. Se comprueba `process.env.NODE_ENV`. `if (process.env.NODE_ENV === 'development') { ... }`                                                                                                                                                                                                                        |
| **Portabilidad**                 | **Comprobaciones en Tiempo de Ejecución**. Se inspecciona el sistema operativo. `const os = require('os'); if (os.platform() === 'win32') { ... }`                                                                                                                                                                                          |
| **Eliminación de Código Muerto** | **Bundlers (Webpack, Vite, etc.)**. Estas herramientas pueden analizar el código. Si ven un bloque `if (false) { ... }` o `if (process.env.NODE_ENV === 'production') { ... }` (y se está empaquetando para desarrollo), pueden eliminar el bloque de código inalcanzable del paquete final. Esto se conoce como **Dead Code Elimination**. |

**Ejemplo de Eliminación de Código Muerto en JS:**

```javascript
// Durante el empaquetado, la variable __DEV__ es reemplazada por 'true' o 'false'.
if (__DEV__) {
  console.log("Esto solo aparecerá en el paquete de desarrollo.");
} else {
  // En el paquete de producción, el bloque 'if' y su contenido se eliminan por completo.
}
```

Este mecanismo, aunque ocurre en una "fase de construcción" similar al preprocesamiento, es parte del ecosistema de herramientas de JavaScript, no una característica del lenguaje en sí.

## Resumen

- La compilación condicional es una herramienta de preprocesamiento para controlar qué código se compila.
- `#ifdef`/`#ifndef` comprueban la **definición** de una macro.
- `#if`/`#elif`/`#else` evalúan **expresiones constantes**.
- El operador `defined()` permite construir expresiones lógicas complejas con macros.
- Es la técnica fundamental en C para escribir código **portable** y para gestionar **configuraciones de compilación** (como depuración vs. producción).
- El ecosistema de JavaScript logra un efecto similar a través de variables de entorno y la eliminación de código muerto por parte de los empaquetadores (bundlers).
